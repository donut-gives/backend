name: Deploy Backend

on:
  push:
    branches: [ staging ]
  
  

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - run: |
          cat > config.yaml << EOF
          app:
            name: "Donut Backend"
            version: "0.0.1-dev"
            desc: "Shaping new gen change makers"
          db:
            url: "${{ secrets.DB_STAGING_URL }}"
          auth:
            jwt_secret: "${{ secrets.JWT_SECRET_STAGING }}"
            google:
              client_id: "${{ secrets.GOOGLE_OAUTH_CLIENT_ID_STAGING }}"
              client_secret: "${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET_STAGING }}"
          emailer:
            email: "${{ secrets.GMAIL }}"
            apppassword: "${{ secrets.GMAIL_APP_PASSWORD }}"
          cloud:
            keyfile: "staging-keys.json"
            userbucket : "${{ secrets.GCLOUD_BUCKET_STAGING }}"
          EOF
      - run: |
          cat > staging-keys.json << EOF
          {
            "type": "service_account",
            "project_id": "donut-366007",
            "private_key_id": "${{ secrets.GCLOUD_BUCKET_PRIVATE_KEY_ID }}",
            "private_key": "${{ secrets.GCLOUD_BUCKET_PRIVATE_KEY }}",
            "client_email": "${{ secrets.GCLOUD_BUCKET_CLIENT_EMAIL }}",
            "client_id": "${{ secrets.GCLOUD_BUCKET_CLIENT_ID }}",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "${{ secrets.GCLOUD_BUCKET_CLIENT_CERT_URL }}"
          }
          EOF
      - run: |
          cat > app.yaml << EOF
          runtime: go116
          service: staging-api
          handlers:
            - url: /.*
              script: auto
              secure: always
              redirect_http_response_code: 301
          EOF
      - run: |
          cat > .env << EOF
          PORT=37227
          GIN_MODE="debug"
          ENV=staging
          EOF
      - id: 'auth'
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: '${{ secrets.GCP_SERVICE_KEY }}'
      - id: 'deploy'
        uses: 'google-github-actions/deploy-appengine@v0'
        with:
          project_id: donut-366007
